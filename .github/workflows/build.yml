name: Build Android (Dev)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: "APK variant"
        required: true
        default: "debug"
        type: choice
        options:
          - debug
          - release

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set build type
        id: vars
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type }}"
          if [ -z "$BUILD_TYPE" ]; then
            BUILD_TYPE="debug"
          fi
          echo "build_type=$BUILD_TYPE" >> "$GITHUB_OUTPUT"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Install dependencies
        run: npm ci

      - name: Generate native code
        run: npx expo prebuild --platform android --clean --non-interactive

      - name: Build APK
        working-directory: android
        run: |
          if [ "${{ steps.vars.outputs.build_type }}" = "release" ]; then
            ./gradlew --no-daemon assembleRelease
          else
            ./gradlew --no-daemon assembleDebug
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: learnify-mobile-${{ steps.vars.outputs.build_type }}.apk
          path: android/app/build/outputs/apk/${{ steps.vars.outputs.build_type }}/*.apk
